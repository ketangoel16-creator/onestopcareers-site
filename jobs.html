<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OneStopCareers - Job Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    /* Active navigation link style */
    .nav-active {
        color: #ea580c; /* Orange-600 */
        font-weight: 600;
        border-bottom: 2px solid #ea580c;
    }
    .toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 101;
        left: 50%;
        bottom: 30px;
        opacity: 0;
        transition: visibility 0s, opacity 0.5s linear;
    }
    .toast.show {
        visibility: visible;
        opacity: 1;
    }
    /* Custom select style */
    .custom-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="OneStopCareers Logo" class="rounded-full mr-2 h-10 w-10 object-cover" />
        <a href="index.html" class="text-2xl font-bold">OneStopCareers</a>
      </div>
      <nav class="hidden md:flex items-center space-x-6">
        <a href="index.html" class="text-gray-600 hover:text-orange-600 font-medium">Home</a>
        <a href="jobs.html" class="text-gray-600 hover:text-orange-600 font-medium nav-active">Find Jobs/referrals</a>
        <a href="resources.html" class="text-gray-600 hover:text-orange-600 font-medium">Resources</a>
        <a href="mentors.html" class="text-gray-600 hover:text-orange-600 font-medium">Mentors</a>
      </nav>
       <!-- Auto-refresh Toggle (Desktop) -->
      <div class="hidden md:flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-600" title="Automatically refresh data every minute">Auto-Refresh</span>
          <label for="auto-refresh-toggle" class="inline-flex relative items-center cursor-pointer">
              <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-orange-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
          </label>
      </div>
      <button id="mobile-menu-btn" class="md:hidden text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
      </button>
    </div>
    <nav id="mobile-menu" class="hidden md:hidden bg-white shadow-lg py-2">
      <a href="index.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Home</a>
      <a href="jobs.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Find Jobs/referrals</a>
      <a href="resources.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Resources</a>
      <a href="mentors.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Mentors</a>
       <!-- Auto-refresh Toggle (Mobile) -->
      <div class="px-4 py-3 flex items-center justify-between border-t border-gray-200">
           <span class="text-sm font-medium text-gray-800">Auto-Refresh</span>
           <label for="auto-refresh-toggle-mobile" class="inline-flex relative items-center cursor-pointer">
              <input type="checkbox" id="auto-refresh-toggle-mobile" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-orange-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
          </label>
      </div>
    </nav>
  </header>

  <!-- Job Board -->
  <section id="jobs" class="max-w-7xl mx-auto px-4 py-16">
    <div class="text-center">
        <h3 class="text-4xl font-bold text-gray-800 mb-2 border-b-4 border-orange-500 inline-block pb-2">Job Board</h3>
        <p class="text-gray-600 mb-8">Check out recent openings from top companies.</p>
    </div>
    
    <!-- Job Filters -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-12">
        <select id="company-filter" class="custom-select w-full md:w-auto p-3 rounded-lg border-2 border-gray-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            <option value="All">All Companies</option>
        </select>
        <select id="location-filter" class="custom-select w-full md:w-auto p-3 rounded-lg border-2 border-gray-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            <option value="All">All Locations</option>
        </select>
    </div>

    <div id="job-board-loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="display: none;">
      <!-- Skeleton loader for jobs -->
      <div class="bg-white p-6 rounded-xl shadow-lg border animate-pulse flex items-center gap-6">
        <div class="h-20 w-20 bg-gray-200 rounded-full flex-shrink-0"></div>
        <div class="flex-1 space-y-3">
            <div class="h-5 bg-gray-200 rounded w-3/4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            <div class="h-10 bg-orange-200 rounded-lg w-24 mt-2"></div>
        </div>
      </div>
    </div>
    <div id="job-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    <div id="pagination-controls" class="flex justify-center items-center space-x-4 mt-12" style="display: none;">
      <button id="prev-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>Previous</button>
      <span id="page-info" class="text-gray-600">Page 1 of 1</span>
      <button id="next-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>Next</button>
    </div>
  </section>

  <!-- Referral Network Section -->
  <section id="referrals" class="bg-orange-50 py-16">
    <div class="max-w-7xl mx-auto px-4">
        <div class="text-center">
            <h3 class="text-4xl font-bold text-gray-800 mb-2 border-b-4 border-orange-500 inline-block pb-2">Referral Network</h3>
            <p class="text-gray-600 mb-8">Connect with professionals willing to give referrals at top companies.</p>
        </div>
        
        <!-- Referral Filters -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-12">
            <input type="text" id="referral-search" placeholder="Search by name or title..." class="w-full md:w-auto p-3 rounded-lg border-2 border-gray-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
            <select id="referral-company-filter" class="custom-select w-full md:w-auto p-3 rounded-lg border-2 border-gray-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">All Companies</option>
            </select>
        </div>


        <!-- Loading State for Referrals -->
        <div id="referral-loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
            <!-- Skeleton for referral card -->
        </div>
        <!-- Grid to display referral cards -->
        <div id="referral-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <!-- Pagination for Referrals -->
        <div id="referral-pagination-controls" class="flex justify-center items-center space-x-4 mt-12" style="display: none;">
            <button id="referral-prev-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>Previous</button>
            <span id="referral-page-info" class="text-gray-600">Page 1 of 1</span>
            <button id="referral-next-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>Next</button>
        </div>
    </div>
  </section>

  <section id="jobs-testimonials" class="bg-gray-800 py-16 text-white">
    <div class="max-w-7xl mx-auto px-4 text-center">
      <h3 class="text-4xl font-bold">Success Stories from Our Job Seekers</h3>
      <p class="text-gray-300 mt-4 max-w-3xl mx-auto">
        Read how our platform helped people find and land their dream jobs.
      </p>
      <div class="grid md:grid-cols-2 gap-8 mt-12">
        <div class="p-8 bg-gray-700 rounded-2xl text-left">
          <p class="text-gray-200 italic">
            "I was struggling to find relevant job openings, but the filters and personalized alerts here made it so easy. I landed a job in just three weeks!"
          </p>
          <p class="mt-4 font-semibold text-orange-500">- Jane Doe, Product Manager</p>
        </div>
        <div class="p-8 bg-gray-700 rounded-2xl text-left">
          <p class="text-gray-200 italic">
            "The combination of the job board and referral tips helped me get my foot in the door at a top company. I wouldn't have found the opportunity otherwise."
          </p>
          <p class="mt-4 font-semibold text-orange-500">- John Smith, Software Engineer</p>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-gray-200 py-16 text-center">
    <div class="max-w-7xl mx-auto px-4">
      <h3 class="text-4xl font-bold text-gray-800">Not Getting Interview Calls?</h3>
      <p class="mt-4 text-gray-600">
        If you're not getting traction on your applications, the problem might not be with the jobs themselves. Get a personalized roadmap from a mentor.
      </p>
      <a href="mentors.html" class="inline-block mt-8 bg-orange-500 text-white text-lg font-semibold px-8 py-4 rounded-xl shadow-lg hover:bg-orange-600 transition-colors">
        Find Your Mentorship →
      </a>
    </div>
  </section>

  <footer class="bg-gray-900 text-white py-6 text-center">
    <p>© 2025 OneStopCareers. All rights reserved.</p>
  </footer>

  <!-- Job Details Modal -->
  <div id="job-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h4 id="modal-title" class="text-2xl font-bold text-orange-700 mb-2"></h4>
      <p id="modal-company-location" class="text-gray-600 font-medium mb-4"></p>
      <p id="modal-description" class="text-gray-700 whitespace-pre-wrap"></p>
      <div class="mt-6 flex justify-between items-center">
        <a id="modal-apply-btn" href="#" target="_blank" class="bg-orange-500 text-white py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors font-semibold">Apply Now</a>
        <button id="modal-share-btn" class="bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors" title="Copy job link">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
            </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">Link copied to clipboard!</div>


  <!-- Pre-loaded data for instant page load -->
  <script id="preloaded-jobs" type="application/json">
    [
      { "id": 1, "Job Title": "Senior Frontend Developer", "Company": "Innovate Inc.", "Location": "San Francisco, CA", "Description": "Join our team to build next-gen web applications using React and TypeScript. 5+ years of experience required.", "Link": "#" },
      { "id": 2, "Job Title": "Product Manager", "Company": "Solutions Co.", "Location": "New York, NY", "Description": "Define product vision, strategy, and roadmap. Work closely with engineering, design, and marketing teams.", "Link": "#" },
      { "id": 3, "Job Title": "Data Scientist", "Company": "Future Analytics", "Location": "Remote", "Description": "Analyze large datasets to extract meaningful insights. Proficiency in Python, SQL, and machine learning frameworks.", "Link": "#" }
    ]
  </script>
  <script id="preloaded-referrals" type="application/json">
    [
      {"Name": "Alex Johnson", "Designation": "Engineering Manager", "Company name": "Innovate Inc.", "LinkedIn ID url": "#"},
      {"Name": "Brenda Smith", "Designation": "Senior Recruiter", "Company name": "Solutions Co.", "LinkedIn ID url": "#"},
      {"Name": "Charles Brown", "Designation": "Lead Data Scientist", "Company name": "Future Analytics", "LinkedIn ID url": "#"},
      {"Name": "Diana Prince", "Designation": "Software Engineer", "Company name": "Innovate Inc.", "LinkedIn ID url": "#"},
      {"Name": "Edward Nygma", "Designation": "UX Designer", "Company name": "Creative Minds", "LinkedIn ID url": "#"},
      {"Name": "Fiona Glenanne", "Designation": "DevOps Engineer", "Company name": "CloudUp", "LinkedIn ID url": "#"},
      {"Name": "George Costanza", "Designation": "Architect", "Company name": "Vandelay Industries", "LinkedIn ID url": "#"},
      {"Name": "Harleen Quinzel", "Designation": "HR Business Partner", "Company name": "Solutions Co.", "LinkedIn ID url": "#"},
      {"Name": "Indiana Jones", "Designation": "Archaeologist", "Company name": "Barnett College", "LinkedIn ID url": "#"},
      {"Name": "Jack Sparrow", "Designation": "Captain", "Company name": "The Black Pearl", "LinkedIn ID url": "#"},
      {"Name": "Kara Danvers", "Designation": "Journalist", "Company name": "CatCo Worldwide Media", "LinkedIn ID url": "#"},
      {"Name": "Luke Skywalker", "Designation": "Jedi Master", "Company name": "Rebel Alliance", "LinkedIn ID url": "#"}
    ]
  </script>


  <script>
    // --- DOM Elements ---
    const jobBoard = document.getElementById('job-board');
    const jobBoardLoading = document.getElementById('job-board-loading');
    const companyFilter = document.getElementById('company-filter');
    const locationFilter = document.getElementById('location-filter');
    const paginationControls = document.getElementById('pagination-controls');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const jobModal = document.getElementById('job-modal');
    const modalCloseBtn = jobModal.querySelector('.close-btn');
    const modalTitle = document.getElementById('modal-title');
    const modalCompanyLocation = document.getElementById('modal-company-location');
    const modalDescription = document.getElementById('modal-description');
    const modalApplyBtn = document.getElementById('modal-apply-btn');
    const modalShareBtn = document.getElementById('modal-share-btn');
    const toast = document.getElementById('toast');
    
    // Referral Elements
    const referralGrid = document.getElementById('referral-grid');
    const referralLoading = document.getElementById('referral-loading');
    const referralSearch = document.getElementById('referral-search');
    const referralCompanyFilter = document.getElementById('referral-company-filter');
    const referralPaginationControls = document.getElementById('referral-pagination-controls');
    const referralPrevBtn = document.getElementById('referral-prev-btn');
    const referralNextBtn = document.getElementById('referral-next-btn');
    const referralPageInfo = document.getElementById('referral-page-info');
    
    // Auto-Refresh Toggle Elements
    const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
    const autoRefreshToggleMobile = document.getElementById('auto-refresh-toggle-mobile');
    let autoRefreshIntervalId = null;

    // --- State Variables ---
    const jobsPerPage = 6;
    let currentPage = 1;
    let allJobs = [];
    let displayedJobs = [];

    const referralsPerPage = 12;
    let currentReferralPage = 1;
    let allReferrals = [];
    let displayedReferrals = [];

    // --- Config ---
    const CACHE_DURATION = 6 * 60 * 60 * 1000; // 6 hours
    const REFRESH_INTERVAL = 60 * 1000; // 1 minute
    const JOBS_API_URL = 'https://script.google.com/macros/s/AKfycbzxRN194Nx7sio2lGw7yiWBjL63h1eRstGJMCVrrrxzn1pKq2NThKz_GUKtrdQA2Q/exec';
    const REFERRALS_API_URL = 'https://script.google.com/macros/s/AKfycbxkrDnF3ABiwsf2M8dD7hKtCGwQ4XSRdQebmJOqL8jsSpdQtCwrb6xH7KeHxKUoK0IB/exec';

    // --- Mobile Menu Toggle ---
    mobileMenuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    // --- Modal & Toast Logic ---
    const openJobModal = (job) => {
      modalTitle.textContent = job['Job Title'];
      modalCompanyLocation.textContent = `${job['Company']} - ${job['Location']}`;
      modalDescription.textContent = job['Description'];
      modalApplyBtn.href = job['Link'];
      modalShareBtn.dataset.jobId = job.id;
      jobModal.style.display = 'block';
      // history.pushState({jobId: job.id}, '', `?jobId=${job.id}`); // Removed to prevent security error in sandbox
    };

    const closeModal = () => {
        jobModal.style.display = 'none';
        // history.pushState({}, '', window.location.pathname); // Removed to prevent security error in sandbox
    };

    modalCloseBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
      if (event.target === jobModal) {
        closeModal();
      }
    });

    const showToast = (message) => {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    };

    modalShareBtn.addEventListener('click', (e) => {
        const jobId = e.currentTarget.dataset.jobId;
        const url = `${window.location.origin}${window.location.pathname}?jobId=${jobId}`;
        
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = url;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);
        
        showToast('Job link copied to clipboard!');
    });


    // --- Job Rendering and Filtering ---
    const renderJobs = (jobs, page = 1) => {
      jobBoard.innerHTML = ''; // Clear previous results
      const start = (page - 1) * jobsPerPage;
      const end = start + jobsPerPage;
      const paginatedJobs = jobs.slice(start, end);

      if (paginatedJobs.length === 0) {
        jobBoard.innerHTML = '<p class="text-gray-500 text-center col-span-full">No jobs found matching your criteria.</p>';
      } else {
        paginatedJobs.forEach(job => {
          const companyInitial = (job.Company || 'C').charAt(0).toUpperCase();
          const logoUrl = `https://placehold.co/100x100/f97316/FFFFFF?text=${companyInitial}`;

          const jobCard = document.createElement('div');
          jobCard.className = 'job-card bg-white p-6 rounded-xl shadow-lg border hover:shadow-2xl transition-shadow duration-300 flex items-center gap-5 cursor-pointer';
          
          jobCard.innerHTML = `
            <img src="${logoUrl}" alt="${job.Company} Logo" class="w-20 h-20 rounded-full flex-shrink-0 border-4 border-orange-100" onerror="this.onerror=null;this.src='https://placehold.co/100x100/EFEFEF/4A4A4A?text=...';">
            <div class="text-left">
                <h4 class="text-lg font-bold text-gray-800"></h4>
                <p class="text-sm text-gray-500 font-medium mb-3"></p>
                <a href="#" target="_blank" class="inline-block bg-orange-500 text-white py-2 px-5 rounded-full hover:bg-orange-600 transition-colors text-sm font-semibold">Apply Now</a>
            </div>
          `;
          jobCard.querySelector('h4').textContent = job['Job Title'] || 'N/A';
          jobCard.querySelector('p').textContent = `${job['Company'] || 'N/A'} - ${job['Location'] || 'N/A'}`;
          jobCard.querySelector('a').href = job['Link'] || '#';
          
          jobCard.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'a') {
              openJobModal(job);
            }
          });
          jobBoard.appendChild(jobCard);
        });
      }

      const totalPages = Math.ceil(jobs.length / jobsPerPage);
      pageInfo.textContent = `Page ${page} of ${totalPages || 1}`;
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages || totalPages === 0;
      paginationControls.style.display = jobs.length > jobsPerPage ? 'flex' : 'none';
    };
    
    const populateSelectFilter = (selectElement, options, currentFilter) => {
        selectElement.innerHTML = `<option value="All">${selectElement.id.includes('company') ? 'All Companies' : 'All Locations'}</option>`;
        options.forEach(option => {
            selectElement.innerHTML += `<option value="${option}">${option}</option>`;
        });
        selectElement.value = currentFilter;
    };

    const populateJobFilters = (jobs) => {
        const companies = [...new Set(jobs.map(job => job.Company).filter(Boolean))].sort();
        const locations = [...new Set(jobs.map(job => job.Location).filter(Boolean))].sort();
        populateSelectFilter(companyFilter, companies, companyFilter.value);
        populateSelectFilter(locationFilter, locations, locationFilter.value);
    };

    const filterAndRenderJobs = () => {
      const selectedCompany = companyFilter.value;
      const selectedLocation = locationFilter.value;

      displayedJobs = allJobs.filter(job => 
        (selectedCompany === 'All' || job.Company === selectedCompany) &&
        (selectedLocation === 'All' || job.Location === selectedLocation)
      );
      currentPage = 1;
      renderJobs(displayedJobs, currentPage);
    };

    // --- Referral Rendering and Filtering ---
    const renderReferrals = (referrals, page = 1) => {
        referralGrid.innerHTML = '';
        const start = (page - 1) * referralsPerPage;
        const end = start + referralsPerPage;
        const paginatedReferrals = referrals.slice(start, end);

        if (paginatedReferrals.length > 0) {
            paginatedReferrals.forEach(prof => {
                const card = document.createElement('a');
                card.href = prof['LinkedIn ID url'] || '#';
                card.target = '_blank';
                card.className = 'block p-6 bg-white rounded-xl shadow-lg hover:shadow-2xl hover:scale-105 transition-all duration-300';
                card.innerHTML = `
                  <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0 h-12 w-12 flex items-center justify-center bg-blue-100 rounded-full">
                        <svg class="w-7 h-7 text-blue-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M21.75 9.142c0-2.28-1.995-4.142-4.436-4.142H6.686C4.245 5 2.25 6.862 2.25 9.142v4.714c0 2.28 1.995 4.142 4.436 4.142h1.65v2.7l3.28-2.7h4.45c2.441 0 4.436-1.862 4.436-4.142V9.142zM7.5 12.428h9M7.5 10.286h9"></path>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M6.686 4c-2.99 0-5.436 2.31-5.436 5.142v4.714c0 2.833 2.446 5.142 5.436 5.142h1.65v3.3l4.03-3.3h3.7c2.99 0 5.436-2.31 5.436-5.142V9.142C22.5 6.31 20.054 4 17.186 4H6.686zM21.75 9.142c0-2.28-1.995-4.142-4.436-4.142H6.686C4.245 5 2.25 6.862 2.25 9.142v4.714c0 2.28 1.995 4.142 4.436 4.142h1.65v2.7l3.28-2.7h4.45c2.441 0 4.436-1.862 4.436-4.142V9.142zM7.5 12.428h9M7.5 10.286h9"></path>
                        </svg>
                    </div>
                    <div>
                      <h4 class="text-lg font-semibold text-gray-800"></h4>
                      <p class="text-gray-600"></p>
                      <p class="text-sm text-blue-600 font-semibold">Message for Referral</p>
                    </div>
                  </div>
                `;
                card.querySelector('h4').textContent = prof['Name'] || 'N/A';
                card.querySelector('p').textContent = `${prof['Designation']} at ${prof['Company name'] || 'N/A'}`;
                referralGrid.appendChild(card);
            });
        } else {
            referralGrid.innerHTML = '<p class="text-gray-500 text-center col-span-3">No professionals found matching your criteria.</p>';
        }

        const totalPages = Math.ceil(referrals.length / referralsPerPage);
        referralPageInfo.textContent = `Page ${page} of ${totalPages || 1}`;
        referralPrevBtn.disabled = page === 1;
        referralNextBtn.disabled = page === totalPages || totalPages === 0;
        referralPaginationControls.style.display = referrals.length > referralsPerPage ? 'flex' : 'none';
    };

    const populateReferralCompanyFilter = (referrals) => {
        const companies = [...new Set(referrals.map(r => r['Company name']).filter(Boolean))].sort();
        const currentVal = referralCompanyFilter.value;
        referralCompanyFilter.innerHTML = `<option value="">All Companies</option>`;
        companies.forEach(company => {
            referralCompanyFilter.innerHTML += `<option value="${company}">${company}</option>`;
        });
        referralCompanyFilter.value = currentVal;
    };
    
    const filterAndRenderReferrals = () => {
        const searchTerm = referralSearch.value.toLowerCase();
        const company = referralCompanyFilter.value;

        displayedReferrals = allReferrals.filter(prof => 
            ((prof['Name'] || '').toLowerCase().includes(searchTerm) ||
            (prof['Designation'] || '').toLowerCase().includes(searchTerm)) &&
            (company === '' || prof['Company name'] === company)
        );
        currentReferralPage = 1;
        renderReferrals(displayedReferrals, currentReferralPage);
    };

    // --- Data Fetching with Caching ---
    const fetchAndCacheData = async (options) => {
        const { url, cacheKey, setupFunction, forceRefresh = false, showLoading = false, loadingElement, gridElement } = options;

        if (!forceRefresh) {
            const cachedItem = localStorage.getItem(cacheKey);
            if (cachedItem) {
                const { timestamp, data } = JSON.parse(cachedItem);
                if (new Date().getTime() - timestamp < CACHE_DURATION) {
                    console.log(`Loading ${cacheKey} from cache.`);
                    setupFunction(data);
                    return;
                }
            }
        }

        if (showLoading && loadingElement && gridElement) {
            loadingElement.style.display = 'grid';
            gridElement.style.display = 'none';
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            const dataWithIds = data.map((item, index) => ({ ...item, id: index + 1 }));
            
            localStorage.setItem(cacheKey, JSON.stringify({ timestamp: new Date().getTime(), data: dataWithIds }));
            setupFunction(dataWithIds);
        } catch (error) {
            console.error(`Failed to fetch data from ${url}:`, error);
            if(gridElement) gridElement.innerHTML = `<p class="text-red-500 text-center col-span-3">Failed to load data. Please try again later.</p>`;
        } finally {
            if (showLoading && loadingElement && gridElement) {
                loadingElement.style.display = 'none';
                gridElement.style.display = 'grid';
            }
        }
    };

    const setupJobs = (data) => {
        allJobs = data;
        populateJobFilters(allJobs);
        filterAndRenderJobs();
        handleDeepLink();
    };

    const setupReferrals = (data) => {
        allReferrals = data;
        populateReferralCompanyFilter(allReferrals);
        filterAndRenderReferrals();
    };
    
    // --- Auto-Refresh & Deep Link Logic ---
    const handleToggleChange = (isChecked) => {
        autoRefreshToggle.checked = isChecked;
        autoRefreshToggleMobile.checked = isChecked;

        if (isChecked) {
            console.log('Auto-refresh enabled.');
            const options = { forceRefresh: true, showLoading: true };
            fetchAndCacheData({ ...options, url: JOBS_API_URL, cacheKey: 'jobs_cache', loadingElement: jobBoardLoading, gridElement: jobBoard, setupFunction: setupJobs });
            fetchAndCacheData({ ...options, url: REFERRALS_API_URL, cacheKey: 'referrals_cache', loadingElement: referralLoading, gridElement: referralGrid, setupFunction: setupReferrals });

            autoRefreshIntervalId = setInterval(() => {
                console.log('Auto-refreshing data...');
                fetchAndCacheData({ ...options, url: JOBS_API_URL, cacheKey: 'jobs_cache', setupFunction: setupJobs });
                fetchAndCacheData({ ...options, url: REFERRALS_API_URL, cacheKey: 'referrals_cache', setupFunction: setupReferrals });
            }, REFRESH_INTERVAL);
        } else {
            console.log('Auto-refresh disabled.');
            if (autoRefreshIntervalId) {
                clearInterval(autoRefreshIntervalId);
                autoRefreshIntervalId = null;
            }
        }
    };

    const handleDeepLink = () => {
        const params = new URLSearchParams(window.location.search);
        const jobId = params.get('jobId');
        if (jobId) {
            const jobToOpen = allJobs.find(j => j.id == jobId);
            if (jobToOpen) {
                openJobModal(jobToOpen);
            }
        }
    };


    // --- Initial Load & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Render pre-loaded data immediately for instant UI
        try {
            const preloadedJobs = JSON.parse(document.getElementById('preloaded-jobs').textContent);
            setupJobs(preloadedJobs);
        } catch (e) {
            console.error("Could not parse preloaded jobs data.", e);
            jobBoard.innerHTML = `<p class="text-red-500 text-center col-span-full">Could not load initial job data.</p>`;
        }

        try {
            const preloadedReferrals = JSON.parse(document.getElementById('preloaded-referrals').textContent);
            setupReferrals(preloadedReferrals);
        } catch (e) {
            console.error("Could not parse preloaded referrals data.", e);
            referralGrid.innerHTML = `<p class="text-red-500 text-center col-span-3">Could not load initial referral data.</p>`;
        }

        // 2. Fetch fresh data in the background
        setTimeout(() => {
            fetchAndCacheData({ url: JOBS_API_URL, cacheKey: 'jobs_cache', setupFunction: setupJobs });
            fetchAndCacheData({ url: REFERRALS_API_URL, cacheKey: 'referrals_cache', setupFunction: setupReferrals });
        }, 500);


        // Job listeners
        companyFilter.addEventListener('change', filterAndRenderJobs);
        locationFilter.addEventListener('change', filterAndRenderJobs);

        prevBtn.addEventListener('click', () => {  
          if (currentPage > 1) {  
            currentPage--;  
            renderJobs(displayedJobs, currentPage);  
          }  
        });
        nextBtn.addEventListener('click', () => {  
          const totalPages = Math.ceil(displayedJobs.length / jobsPerPage);  
          if (currentPage < totalPages) {  
            currentPage++;  
            renderJobs(displayedJobs, currentPage);  
          }  
        });

        // Referral listeners
        referralSearch.addEventListener('input', filterAndRenderReferrals);
        referralCompanyFilter.addEventListener('change', filterAndRenderReferrals);

        referralPrevBtn.addEventListener('click', () => {
            if (currentReferralPage > 1) {
                currentReferralPage--;
                renderReferrals(displayedReferrals, currentReferralPage);
            }
        });
        referralNextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(displayedReferrals.length / referralsPerPage);
            if (currentReferralPage < totalPages) {
                currentReferralPage++;
                renderReferrals(displayedReferrals, currentReferralPage);
            }
        });

        // Toggle listeners
        autoRefreshToggle.addEventListener('change', (e) => handleToggleChange(e.target.checked));
        autoRefreshToggleMobile.addEventListener('change', (e) => handleToggleChange(e.target.checked));
    });
  </script>

</body>
</html>
